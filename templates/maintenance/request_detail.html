{% extends 'maintenance/base.html' %}

{% block page_title %}Update Maintenance Request{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-tools"></i> Update Maintenance Request
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Request Information (Read-only) -->
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Request Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Subject:</strong> {{ request.subject }}</p>
                                    <p class="mb-1"><strong>Type:</strong> 
                                        {% if request.request_type == 'Preventive' %}
                                            <span class="badge bg-success">{{ request.request_type }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ request.request_type }}</span>
                                        {% endif %}
                                    </p>
                                    <p class="mb-1"><strong>Priority:</strong> 
                                        <span class="badge bg-{% if request.priority == 'Critical' %}danger{% elif request.priority == 'High' %}warning{% else %}info{% endif %}">
                                            {{ request.priority }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>Equipment:</strong> 
                                        <a href="{% url 'maintenance:equipment_list' %}?search={{ request.equipment.equipment_name }}" 
                                           class="text-decoration-none">
                                            {{ request.equipment.equipment_name }}
                                        </a>
                                    </p>
                                    <p class="mb-1"><strong>Serial:</strong> {{ request.equipment.serial_number }}</p>
                                    <p class="mb-1">
                                        <strong>Team:</strong> 
                                        {% if request.maintenance_team %}
                                            <a href="{% url 'maintenance:admin_teams' %}" class="text-decoration-none">
                                                {{ request.maintenance_team.team_name }}
                                            </a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% if request.description %}
                                <hr>
                                <p class="mb-0"><strong>Description:</strong><br>{{ request.description }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Task Timing Information -->
                    {% if request.actual_start_time or request.actual_end_time or request.duration_hours %}
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Task Timing</h6>
                            <div class="row">
                                {% if request.actual_start_time %}
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Started:</strong><br>
                                        {{ request.actual_start_time|date:"M d, Y H:i" }}
                                    </p>
                                </div>
                                {% endif %}
                                {% if request.actual_end_time %}
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Ended:</strong><br>
                                        {{ request.actual_end_time|date:"M d, Y H:i" }}
                                    </p>
                                </div>
                                {% endif %}
                                {% if request.duration_hours %}
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Duration:</strong><br>
                                        <span class="badge bg-success" style="font-size: 1rem;">{{ request.duration_hours }} hours</span>
                                    </p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Start/End Task Buttons (for technicians) -->
                    {% if user.profile.role == 'Technician' and request.assigned_technician == user %}
                    <div class="mb-3">
                        {% if request.stage == 'New' %}
                            <button type="button" class="btn btn-success btn-lg w-100" id="startTaskBtn" data-request-id="{{ request.pk }}">
                                <i class="bi bi-play-circle"></i> Start Task
                            </button>
                        {% elif request.stage == 'In Progress' %}
                            <button type="button" class="btn btn-danger btn-lg w-100" id="endTaskBtn" data-request-id="{{ request.pk }}">
                                <i class="bi bi-stop-circle"></i> End Task & Mark as Repaired
                            </button>
                            <small class="text-muted d-block mt-2 text-center">
                                Task started at: {{ request.actual_start_time|date:"M d, Y H:i" }}
                            </small>
                        {% elif request.stage == 'Repaired' and request.duration_hours %}
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> Task completed in <strong>{{ request.duration_hours }} hours</strong>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Status Update -->
                    <div class="mb-3">
                        <label for="{{ form.stage.id_for_label }}" class="form-label">
                            <strong>Status</strong> <span class="text-danger">*</span>
                        </label>
                        {{ form.stage }}
                        {% if form.stage.errors %}
                            <div class="text-danger small">{{ form.stage.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Status flow: New → In Progress → Repaired/Scrap
                        </small>
                    </div>

                    <!-- Duration Hours - Only show if not auto-calculated -->
                    {% if form.duration_hours.field.widget.input_type != 'hidden' %}
                    <div class="mb-3">
                        <label for="{{ form.duration_hours.id_for_label }}" class="form-label">
                            <strong>Duration (Hours)</strong>
                        </label>
                        {{ form.duration_hours }}
                        {% if form.duration_hours.errors %}
                            <div class="text-danger small">{{ form.duration_hours.errors }}</div>
                        {% endif %}
                        {% if form.duration_hours.help_text %}
                            <small class="form-text text-muted">{{ form.duration_hours.help_text }}</small>
                        {% else %}
                            <small class="form-text text-muted">
                                {% if request.stage == 'In Progress' %}
                                    Duration will be automatically calculated when you end the task using the "End Task" button above.
                                {% else %}
                                    Duration will be automatically calculated when you end the task, or enter manually.
                                {% endif %}
                            </small>
                        {% endif %}
                    </div>
                    {% else %}
                        <!-- Duration is auto-calculated, so it's hidden -->
                        {{ form.duration_hours }}
                    {% endif %}

                    <!-- Technician Notes -->
                    <div class="mb-3">
                        <label for="{{ form.technician_notes.id_for_label }}" class="form-label">
                            <strong>Technician Notes</strong>
                        </label>
                        {{ form.technician_notes }}
                        {% if form.technician_notes.errors %}
                            <div class="text-danger small">{{ form.technician_notes.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Add notes about the work performed, issues found, etc.</small>
                    </div>

                    <!-- Resolution Summary -->
                    <div class="mb-3">
                        <label for="{{ form.resolution_summary.id_for_label }}" class="form-label">
                            <strong>Resolution Summary</strong>
                            {% if request.stage == 'Repaired' or form.stage.value == 'Repaired' %}
                                <span class="text-danger">*</span>
                            {% endif %}
                        </label>
                        {{ form.resolution_summary }}
                        {% if form.resolution_summary.errors %}
                            <div class="text-danger small">{{ form.resolution_summary.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Required when marking as "Repaired". Describe what was fixed and how.
                        </small>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'maintenance:technician_dashboard' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Dashboard
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Update Request
                        </button>
                    </div>
                </form>

                <!-- Start Task Modal -->
                <div class="modal fade" id="startTaskModal" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-header bg-primary text-white border-0">
                                <h5 class="modal-title"><i class="bi bi-play-circle"></i> Start Task</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body py-4">
                                <p class="mb-3">Are you ready to start this maintenance task?</p>
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-clock"></i> The timer will begin now and track your work duration.
                                </div>
                            </div>
                            <div class="modal-footer border-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-primary" id="confirmStartBtn">
                                    <i class="bi bi-play"></i> Start
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    #startTaskModal, #endTaskModal {
                        display: none !important;
                    }
                    
                    #startTaskModal.show, #endTaskModal.show {
                        display: block !important;
                        animation: none !important;
                    }
                    
                    .modal.show {
                        pointer-events: auto !important;
                    }
                    
                    .modal-backdrop {
                        animation: none !important;
                        opacity: 0.5 !important;
                    }
                    
                    .modal-dialog {
                        animation: none !important;
                        margin-top: auto !important;
                        margin-bottom: auto !important;
                    }
                    
                    .modal-content {
                        animation: none !important;
                        transform: none !important;
                    }
                </style>

                <!-- End Task Modal -->
                <div class="modal fade" id="endTaskModal" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-header bg-success text-white border-0">
                                <h5 class="modal-title"><i class="bi bi-stop-circle"></i> Complete Task</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body py-4">
                                <p class="mb-3">Are you sure you want to mark this task as <strong>Repaired</strong>?</p>
                                <div class="alert alert-success mb-0">
                                    <i class="bi bi-check-circle"></i> Duration will be automatically calculated.
                                </div>
                            </div>
                            <div class="modal-footer border-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-success" id="confirmEndBtn">
                                    <i class="bi bi-check"></i> Mark as Repaired
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const startBtn = document.getElementById('startTaskBtn');
                    const endBtn = document.getElementById('endTaskBtn');
                    const startTaskModalEl = document.getElementById('startTaskModal');
                    const endTaskModalEl = document.getElementById('endTaskModal');
                    const startTaskModal = new bootstrap.Modal(startTaskModalEl, { backdrop: 'static', keyboard: false });
                    const endTaskModal = new bootstrap.Modal(endTaskModalEl, { backdrop: 'static', keyboard: false });
                    let currentRequestId = null;
                    let isProcessing = false;
                    let modalShown = false;
                    
                    // Prevent modal from closing on accidental triggers
                    startTaskModalEl.addEventListener('mousemove', function(e) {
                        e.stopPropagation();
                    });
                    endTaskModalEl.addEventListener('mousemove', function(e) {
                        e.stopPropagation();
                    });
                    
                    if (startBtn) {
                        startBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            if (!isProcessing && !modalShown) {
                                modalShown = true;
                                currentRequestId = this.dataset.requestId;
                                startTaskModal.show();
                            }
                        });
                    }
                    
                    startTaskModalEl.addEventListener('hidden.bs.modal', function() {
                        modalShown = false;
                        isProcessing = false;
                    });
                    
                    document.getElementById('confirmStartBtn').addEventListener('click', function() {
                        if (currentRequestId && !isProcessing) {
                            isProcessing = true;
                            this.disabled = true;
                            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting...';
                            
                            fetch(`/technician/requests/${currentRequestId}/start-task/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    startTaskModal.hide();
                                    location.reload();
                                } else {
                                    alert('Error: ' + data.error);
                                    isProcessing = false;
                                    this.disabled = false;
                                    this.innerHTML = '<i class="bi bi-play"></i> Start';
                                }
                            })
                            .catch(error => {
                                alert('An error occurred. Please try again.');
                                isProcessing = false;
                                this.disabled = false;
                                this.innerHTML = '<i class="bi bi-play"></i> Start';
                            });
                        }
                    });
                    
                    if (endBtn) {
                        endBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            if (!isProcessing && !modalShown) {
                                modalShown = true;
                                currentRequestId = this.dataset.requestId;
                                endTaskModal.show();
                            }
                        });
                    }
                    
                    endTaskModalEl.addEventListener('hidden.bs.modal', function() {
                        modalShown = false;
                        isProcessing = false;
                    });
                    
                    document.getElementById('confirmEndBtn').addEventListener('click', function() {
                        if (currentRequestId && !isProcessing) {
                            isProcessing = true;
                            this.disabled = true;
                            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Completing...';
                            
                            fetch(`/technician/requests/${currentRequestId}/end-task/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    endTaskModal.hide();
                                    const successMsg = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                                        <i class="bi bi-check-circle"></i> <strong>Task Completed!</strong> Duration: ${data.duration_hours} hours
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>`;
                                    document.body.insertAdjacentHTML('afterbegin', successMsg);
                                    setTimeout(() => location.reload(), 2000);
                                } else {
                                    alert('Error: ' + data.error);
                                    isProcessing = false;
                                    this.disabled = false;
                                    this.innerHTML = '<i class="bi bi-check"></i> Mark as Repaired';
                                }
                            })
                            .catch(error => {
                                alert('An error occurred. Please try again.');
                                isProcessing = false;
                                this.disabled = false;
                                this.innerHTML = '<i class="bi bi-check"></i> Mark as Repaired';
                            });
                        }
                    });
                });
                </script>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Request Details Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Request Details</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>Created:</strong><br>{{ request.created_at|date:"M d, Y H:i" }}</p>
                <p class="mb-2"><strong>Created By:</strong><br>{{ request.created_by.get_full_name|default:request.created_by.username }}</p>
                {% if request.scheduled_date %}
                    <p class="mb-2"><strong>Scheduled:</strong><br>{{ request.scheduled_date|date:"M d, Y" }}</p>
                {% endif %}
                {% if request.completed_date %}
                    <p class="mb-2"><strong>Completed:</strong><br>{{ request.completed_date|date:"M d, Y" }}</p>
                {% endif %}
                {% if request.duration_hours %}
                    <p class="mb-2"><strong>Duration:</strong><br>{{ request.duration_hours }} hours</p>
                {% endif %}
                {% if request.is_overdue %}
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-exclamation-triangle"></i> This request is overdue!
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Equipment Details Card -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Equipment Details</h6>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Name:</strong> {{ request.equipment.equipment_name }}</p>
                <p class="mb-1"><strong>Serial:</strong> {{ request.equipment.serial_number }}</p>
                <p class="mb-1"><strong>Category:</strong> {{ request.equipment.category }}</p>
                {% if request.equipment.location %}
                    <p class="mb-1"><strong>Location:</strong> {{ request.equipment.location }}</p>
                {% endif %}
                {% if request.equipment.department %}
                    <p class="mb-0"><strong>Department:</strong> {{ request.equipment.department }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

