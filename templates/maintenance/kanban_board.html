{% extends 'maintenance/base.html' %}
{% load maintenance_tags %}

{% block page_title %}Kanban Board - Maintenance Requests{% endblock %}

{% block extra_css %}
<style>
    .kanban-board {
        display: flex;
        gap: 15px;
        overflow-x: auto;
        padding: 20px 0;
        min-height: 600px;
    }
    .kanban-column {
        flex: 1;
        min-width: 300px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .kanban-column-header {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .kanban-card {
        background: white;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        cursor: move;
        transition: all 0.3s;
        border-left: 4px solid #0d6efd;
    }
    .kanban-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    .kanban-card.dragging {
        opacity: 0.5;
    }
    .kanban-card.overdue {
        border-left-color: #dc3545;
    }
    .kanban-card.high-priority {
        border-left-color: #ffc107;
    }
    .kanban-card.critical-priority {
        border-left-color: #dc3545;
    }
    .card-subject {
        font-weight: bold;
        margin-bottom: 8px;
        color: #212529;
    }
    .card-equipment {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 8px;
    }
    .card-technician {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e9ecef;
    }
    .card-technician img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
    }
    .card-badges {
        display: flex;
        gap: 5px;
        margin-top: 8px;
        flex-wrap: wrap;
    }
    .badge-overdue {
        background-color: #dc3545;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    .column-new { border-top: 3px solid #0d6efd; }
    .column-in-progress { border-top: 3px solid #ffc107; }
    .column-repaired { border-top: 3px solid #198754; }
    .column-scrap { border-top: 3px solid #6c757d; }
    .count-badge {
        background-color: #0d6efd;
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-kanban"></i> Maintenance Requests Kanban Board</h5>
        <div>
            <a href="{% url 'maintenance:request_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-list"></i> List View
            </a>
            <a href="{% url 'maintenance:manager_dashboard' %}" class="btn btn-sm btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
    <div class="card-body">
        <div class="kanban-board" id="kanbanBoard">
            {% for stage in stages %}
                <div class="kanban-column column-{{ stage|lower|slugify }} {% if stage == 'New' %}column-new{% elif stage == 'In Progress' %}column-in-progress{% elif stage == 'Repaired' %}column-repaired{% elif stage == 'Scrap' %}column-scrap{% endif %}" 
                     data-stage="{{ stage }}">
                    <div class="kanban-column-header">
                        <span>{{ stage }}</span>
                        <span class="count-badge">{{ requests_by_stage|get_item:stage|length }}</span>
                    </div>
                    <div class="kanban-cards" id="stage-{{ stage|slugify }}">
                        {% for request in requests_by_stage|get_item:stage %}
                            <div class="kanban-card {% if request.is_overdue %}overdue{% endif %} {% if request.priority == 'High' %}high-priority{% endif %} {% if request.priority == 'Critical' %}critical-priority{% endif %}" 
                                 draggable="true" 
                                 data-request-id="{{ request.pk }}"
                                 data-stage="{{ request.stage }}">
                                <div class="card-subject">{{ request.subject }}</div>
                                <div class="card-equipment">
                                    <i class="bi bi-tools"></i> {{ request.equipment.equipment_name }}
                                </div>
                                {% if request.maintenance_team %}
                                    <div class="card-equipment">
                                        <i class="bi bi-people"></i> {{ request.maintenance_team.team_name }}
                                    </div>
                                {% endif %}
                                <div class="card-badges">
                                    <span class="badge bg-{% if request.priority == 'Critical' %}danger{% elif request.priority == 'High' %}warning{% elif request.priority == 'Medium' %}info{% else %}secondary{% endif %}">
                                        {{ request.priority }}
                                    </span>
                                    {% if request.is_overdue %}
                                        <span class="badge-overdue">Overdue</span>
                                    {% endif %}
                                </div>
                                {% if request.assigned_technician %}
                                    <div class="card-technician">
                                        <i class="bi bi-person-circle"></i>
                                        <small>{{ request.assigned_technician.get_full_name|default:request.assigned_technician.username }}</small>
                                    </div>
                                {% endif %}
                                <div class="mt-2">
                                    <a href="{% url 'maintenance:request_update' request.pk %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i> View Details
                                    </a>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox"></i><br>
                                No requests in this stage
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.kanban-card');
    const columns = document.querySelectorAll('.kanban-column');
    
    let draggedCard = null;
    
    // Drag and drop event handlers
    cards.forEach(card => {
        card.addEventListener('dragstart', function(e) {
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        });
        
        card.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
            draggedCard = null;
        });
    });
    
    columns.forEach(column => {
        column.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(this.querySelector('.kanban-cards'), e.clientY);
            const cardsContainer = this.querySelector('.kanban-cards');
            
            if (afterElement == null) {
                cardsContainer.appendChild(draggedCard);
            } else {
                cardsContainer.insertBefore(draggedCard, afterElement);
            }
        });
        
        column.addEventListener('drop', function(e) {
            e.preventDefault();
            const newStage = this.dataset.stage;
            const requestId = draggedCard.dataset.requestId;
            
            // Update via AJAX
            const formData = new FormData();
            formData.append('stage', newStage);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch(`/manager/requests/${requestId}/update-stage/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update card data attribute
                    draggedCard.dataset.stage = newStage;
                    
                    // Update count badges
                    updateCountBadges();
                    
                    // Show success message
                    showNotification('Request moved to ' + newStage, 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                    // Reload page to reset
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred. Please try again.', 'error');
                location.reload();
            });
        });
    });
    
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    function updateCountBadges() {
        const stages = ['New', 'In Progress', 'Repaired', 'Scrap'];
        stages.forEach(stage => {
            const column = document.querySelector(`[data-stage="${stage}"]`);
            const cards = column.querySelectorAll('.kanban-card').length;
            const badge = column.querySelector('.count-badge');
            if (badge) {
                badge.textContent = cards;
            }
        });
    }
    
    function showNotification(message, type) {
        // Simple notification - you can enhance this with a toast library
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
});
</script>
{% endblock %}

